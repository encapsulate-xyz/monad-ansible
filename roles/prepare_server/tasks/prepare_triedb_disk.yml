---
- name: Install apt packages
  ansible.builtin.apt:
    name: nvme-cli
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Create GPT partition table
  ansible.builtin.command: "parted {{ triedb_drive }} mklabel gpt"
  register: partition_table_result
  failed_when: false
  changed_when: false

- name: Create partition spanning entire drive
  ansible.builtin.command: "parted {{ triedb_drive }} mkpart triedb 0% 100%"
  register: partition_result
  changed_when: true

- name: Wait for partition to be created
  ansible.builtin.pause:
    seconds: 30

- name: Get partition UUID
  ansible.builtin.shell: |
    set -o pipefail
    lsblk -o PARTUUID {{ triedb_drive }} | tail -n 1
  register: partuuid_result
  changed_when: false

- name: Set partition UUID fact
  ansible.builtin.set_fact:
    partition_uuid: "{{ partuuid_result.stdout.strip() }}"

- name: Display partition_uuid
  ansible.builtin.debug:
    msg: "partition_uuid: {{ partition_uuid }}"

- name: Create udev rule for TrieDB partition
  ansible.builtin.lineinfile:
    path: /etc/udev/rules.d/99-triedb.rules
    line: 'ENV{ID_PART_ENTRY_UUID}=="{{ partition_uuid }}", MODE="0666", SYMLINK+="triedb"'
    create: true
    owner: root
    group: root
    mode: "0644"
  notify:
    - Trigger udev rules
    - Reload udev rules

- name: Wait for symlink to be created
  ansible.builtin.pause:
    seconds: 15

- name: Set permissions on /dev/triedb
  ansible.builtin.file:
    path: /dev/triedb
    mode: "0666"
  register: permissions_result

- name: Verify symlink exists
  ansible.builtin.stat:
    path: /dev/triedb
  register: symlink_stat

- name: Verify final LBA configuration
  ansible.builtin.shell: |
    set -o pipefail
    nvme id-ns -H {{ triedb_drive }} | grep 'LBA Format' | grep 'in use'
  register: final_lba_check
  changed_when: false

- name: Display final LBA configuration
  ansible.builtin.debug:
    msg: "Final LBA configuration: {{ final_lba_check.stdout }}"
