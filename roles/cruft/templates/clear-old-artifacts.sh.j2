#!/bin/bash

log() {
  echo "[$(date +"%Y-%m-%d %H:%M:%S")] $1"
}

log "Starting cruft script"

TARGET_DIR="{{ consensus_home_dir }}/data/"

NEW_FILES=$(find "$TARGET_DIR" -type f -name "*" -mmin -20)
if [ -n "$NEW_FILES" ]; then
    find {{ consensus_home_dir }}/config/forkpoint/ -type f -name "forkpoint.toml.*" -mmin +300 -delete 2>/dev/null
    find {{ consensus_home_dir }}/config/validators/ -type f -name "validators.toml.*" -mmin +30 -delete 2>/dev/null
    find {{ consensus_home_dir }}/data/headers -type f -mmin +600 -delete 2>/dev/null
    find {{ consensus_home_dir }}/data/bodies -type f -mmin +600 -delete 2>/dev/null
    find {{ consensus_home_dir }}/ -type f -name "wal_*" -mmin +300 -delete 2>/dev/null
else
    echo "No new files detected. Skipping deletion of .header files."
fi

log "Cruft script completed"

exit 0
